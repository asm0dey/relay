# Implementation Plan: Protobuf Serialization Migration (v2.0.0)

**Branch**: `004-protobuf-serialization` | **Date**: 2026-02-14 | **Spec**: [spec.md](./spec.md)  
**Version**: 2.0.0 (Breaking Change)  
**Input**: Feature specification from `/specs/004-protobuf-serialization/spec.md`

---

## Summary

Migrate the Relay tunneling service from JSON to Protobuf serialization for WebSocket protocol messages. Uses kotlinx.serialization's ProtoBuf format with existing `@Serializable` data classes. **This is a breaking change (v2.0.0)** - JSON support is removed entirely. Both client and server must upgrade together.

Primary goals: 30%+ bandwidth reduction, faster serialization, and simplified protocol (no dual format support).

---

## Technical Context

**Language/Version**: Kotlin 2.3.10 / Java 21  
**Primary Dependencies**: 
- Quarkus 3.31.3 (server, client frameworks)
- kotlinx.serialization-protobuf 1.10.0 (NEW - replaces JSON)

**Storage**: N/A (in-memory protocol messages)  
**Testing**: JUnit 5, Mockito, Quarkus Test, Awaitility  
**Target Platform**: JVM (Linux servers, CLI client)  
**Project Type**: Multi-module (shared protocol, server, client)  
**Performance Goals**: 
- 30%+ message size reduction vs JSON
- Serialization <1ms for 1MB messages
- No p99 latency regression (>10%)

**Constraints**: 
- Breaking change - no backward compatibility
- All connections use Protobuf immediately
- No format negotiation

**Scale/Scope**: 
- Reuse existing 6 `@Serializable` data classes
- No code generation required
- 3 modules affected (shared, server, client)
- Remove JSON serialization code

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Specification-Driven | âœ… PASS | Spec complete with requirements |
| II. Progressive Disclosure | âœ… PASS | Breaking change simplifies implementation |
| III. Test-First (NON-NEGOTIABLE) | ðŸ“ CHECK | Tests required before implementation |
| IV. Modularity | âœ… PASS | Serialization isolated in shared module |
| V. Observability | âœ… PASS | Error logging for malformed messages |

**Constitution Enforcement Rules**:
- [MUST] Write failing tests before implementation (TDD)
- [MUST] All functionality verifiable through automated tests
- [MUST] Red-Green-Refactor cycle mandatory
- [MUST NOT] Silent failures - error conditions must be explicit
- [REQUIRED] Input validation for all external data (Protobuf messages)

---

## Project Structure

### Documentation (this feature)

```text
specs/004-protobuf-serialization/
  plan.md              # This file
  spec.md              # Feature specification
  research.md          # Phase 0 output - Protobuf library evaluation
  data-model.md        # Phase 1 output - Data class annotations
  quickstart.md        # Phase 1 output - Testing/verification guide
  analysis.md          # Phase 2 output - Cross-artifact consistency analysis
  contracts/
    websocket-protocol-v2.md  # Updated protocol contract (v2.0.0)
  tasks.md             # Phase 2 output (generated by /iikit-06-tasks)
  tests/
    test-specs.md      # Test specifications (TDD)
  checklists/          # Requirements quality checklists
  MIGRATION.md         # Breaking change notes for v2.0.0 (Task T043)
```

### Source Code (repository root)

```text
shared/src/main/kotlin/org/relay/shared/protocol/
  Envelope.kt           # MODIFY - add @ProtoNumber annotations
  RequestPayload.kt     # MODIFY - add @ProtoNumber annotations, ByteArray body
  ResponsePayload.kt    # MODIFY - add @ProtoNumber annotations, ByteArray body
  ErrorPayload.kt       # MODIFY - add @ProtoNumber annotations
  ControlPayload.kt     # MODIFY - add @ProtoNumber annotations
  Payload.kt            # NEW - sealed class for union type
  ErrorCode.kt          # Existing - enum compatible
  MessageType.kt        # Existing - enum compatible
  SerializationUtils.kt # MODIFY - replace JSON with ProtoBuf

server/src/main/kotlin/org/relay/server/websocket/
  TunnelWebSocketEndpoint.kt    # MODIFY - remove JSON handling, use ProtoBuf only
  ExternalWebSocketEndpoint.kt  # MODIFY - if affected

client/src/main/kotlin/org/relay/client/websocket/
  WebSocketClientEndpoint.kt    # MODIFY - remove JSON, use ProtoBuf only

# Gradle changes
shared/build.gradle.kts         # REPLACE kotlinx-serialization-json with protobuf
server/build.gradle.kts         # No changes needed
client/build.gradle.kts         # No changes needed
```

**Structure Decision**: Leverage existing `@Serializable` data classes with kotlinx.serialization's ProtoBuf format. Add `@ProtoNumber` annotations for field numbering control. No .proto files or code generation needed. Remove all JSON serialization code.

---

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| Breaking change | Eliminates dual format complexity | Maintaining backward compatibility adds significant code complexity for migration support that may never be fully utilized |

---

## Phase 0: Research & Decisions

**Prerequisites**: Constitution Check passed (with TDD checkpoint noted)

### Unknowns Identified

1. **Protobuf Library Selection** - kotlinx.serialization vs Google protobuf-kotlin?
2. **Field Numbering** - How to control with kotlinx.serialization?
3. **Schema Evolution** - Forward/backward compatibility approach?
4. **Binary Format Details** - Wire format differences?

### Research Findings

See [research.md](./research.md) for detailed evaluation.

**Key Decisions**:

| Decision | Choice | Rationale |
----------|--------|-----------|
| Protobuf Library | `kotlinx.serialization-protobuf` | Already using kotlinx.serialization, minimal changes, no code generation, single framework |
| Field Numbering | `@ProtoNumber(n)` annotation | kotlinx.serialization provides this for explicit field ordering |
| Payload Encoding | Sealed class with `@Serializable` | Existing class structure works, use `@ProtoOneOf` for union types |
| Timestamp Format | `@Contextual` with `InstantSerializer` | Reuse existing Instant serializer with ProtoBuf |
| Body Encoding | `ByteArray` raw binary | ~33% size reduction vs Base64, native protobuf binary support |
| Migration Approach | Breaking change (v2.0.0) | Simpler implementation, no dual format complexity |

**kotlinx.serialization-protobuf Features**:
- `ProtoBuf.encodeToByteArray(serializer, value)` - serialize to bytes
- `ProtoBuf.decodeFromByteArray(serializer, bytes)` - deserialize from bytes
- `@ProtoNumber(n)` - explicit field numbers for schema evolution
- `@ProtoOneOf` - union types (oneof equivalent)
- `@ProtoPacked` - packed repeated fields
- Binary format compatible with standard protobuf

---

## Phase 1: Design & Contracts

### Data Model

See [data-model.md](./data-model.md) for annotated class definitions.

**Key Entity Changes**:

```kotlin
// Envelope with ProtoBuf annotations (v2.0.0)
@Serializable
class Envelope(
    @ProtoNumber(1)
    val correlationId: String,
    
    @ProtoNumber(2)
    val type: MessageType,
    
    @ProtoNumber(3)
    @Contextual  // Use custom InstantSerializer
    val timestamp: Instant = Instant.now(),
    
    @ProtoNumber(4)
    val payload: Payload  // Sealed class union
)

// Sealed class for union type (v2.0.0)
@Serializable
sealed class Payload {
    @Serializable
    @SerialName("request")
    data class Request(@ProtoNumber(1) val data: RequestPayload) : Payload()
    
    @Serializable
    @SerialName("response")
    data class Response(@ProtoNumber(1) val data: ResponsePayload) : Payload()
    
    // ... Error, Control
}
```

**Field Numbering Strategy**:
- 1-10: Core envelope fields
- 1-10 per payload type for consistency
- Reserve field numbers for future extensions

### API Contracts

See [contracts/websocket-protocol-v2.md](./contracts/websocket-protocol-v2.md).

**v2.0.0 Protocol Flow**:

```
Client                           Server
  |                                |
  |---- WebSocket connect -------->|
  |                                |
  |---- [Binary Protobuf] -------->|  [REQUEST payload]
  |                                |
  |<--- [Binary Protobuf] ---------|  [RESPONSE payload]
  |                                |
```

**No format negotiation** - First message is Protobuf binary immediately.

### Quickstart

See [quickstart.md](./quickstart.md) for testing scenarios.

**Basic Verification**:
1. Start v2.0.0 server
2. Connect v2.0.0 client
3. Verify tunnel works end-to-end
4. Check metrics: message sizes, serialization times
5. Cannot test with v1.x clients (expected incompatibility)

---

## Tessl Integration Status

### Installed Tiles

| Technology | Tile | Type | Version |
|------------|------|------|---------|
| kotlinx.serialization Core | tessl/maven-org-jetbrains-kotlinx--kotlinx-serialization-core | Documentation | 1.9.0 |
| Protobuf Kotlin | tessl/maven-com-google-protobuf--protobuf-kotlin | Documentation | 4.31.0 |

### Query Results

kotlinx.serialization-protobuf provides:
- `ProtoBuf` format class with `encodeToByteArray()` / `decodeFromByteArray()`
- `@ProtoNumber(n)` for explicit field numbering
- `@ProtoOneOf` for union/oneof types
- `@ProtoPacked` for packed repeated fields
- Binary format compatible with standard protobuf wire format

### Technologies Without Tiles

- kotlinx.serialization-protobuf (format module) - documented in core tile

---

## Output Validation

**Constitution Re-Check (Post-Design)**:

| Principle | Validation | Status |
|-----------|------------|--------|
| I. Spec-Driven | Plan derived from spec.md requirements FR-001 to FR-008 | âœ… PASS |
| II. Progressive Disclosure | Breaking change eliminates complexity | âœ… PASS |
| III. Test-First | TDD checkpoint noted in Phase 2 | ðŸ“ CHECK |
| IV. Modularity | Serialization isolated, clear interfaces | âœ… PASS |
| V. Observability | Error logging for malformed messages | âœ… PASS |

**Phase Separation Validation**:

| Check | Status |
|-------|--------|
| No governance principles in plan | âœ… PASS |
| No project-wide quality standards | âœ… PASS |
| Technology decisions only | âœ… PASS |

---

## Next Steps

Plan complete! Next steps:
- `/iikit-04-checklist` - (Recommended) Generate quality checklists for requirements validation
- `/iikit-05-testify` - Generate test specifications (REQUIRED by constitution TDD principle)
- `/iikit-06-tasks` - Generate task breakdown from plan
